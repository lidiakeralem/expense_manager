{% extends "templates/web.html" %}

{% block page_content %}

<h2>The list of Expense Categories</h2>

<!-- Search Form -->
<div style="margin-bottom:10px;">
    <input type="text" id="category-search-input" placeholder="Type category name..." autocomplete="off">
    <button id="category-search-btn">Search</button>
</div>

<!-- Categories List -->
<ul id="category-list" style="border:1px solid #ccc; padding:5px; display:none;"></ul>

<!-- Add Button (hidden by default) -->
<button id="add-category-btn" style="margin-top:10px; display:none;">Add This Category</button>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('category-search-input');
        const searchBtn = document.getElementById('category-search-btn');
        const list = document.getElementById('category-list');
        const addBtn = document.getElementById('add-category-btn');

        let lastSearchResults = [];

        // Function to fetch categories
        function fetchCategories(term) {
            frappe.call({
                method: 'frappe.client.get_list',
                args: {
                    doctype: 'Expense Category',
                    filters: term ? { 'category_name': ['like', `%${term}%`] } : {},
                    fields: ['category_name', 'description'],
                    limit_page_length: 20
                },
                callback: function (r) {
                    const categories = r.message || [];
                    lastSearchResults = categories;
                    list.innerHTML = '';

                    if (categories.length) {
                        list.style.display = 'block';
                        categories.forEach(c => {
                            const li = document.createElement('li');
                            li.textContent = `${c.category_name} - ${c.description || ''}`;
                            list.appendChild(li);
                        });
                        addBtn.style.display = categories.some(c => c.category_name.toLowerCase() === term.toLowerCase()) ? 'none' : 'inline-block';
                    } else {
                        list.style.display = 'none';
                        addBtn.style.display = term ? 'inline-block' : 'none';
                    }
                }
            });
        }

        // Search button click
        searchBtn.addEventListener('click', function () {
            const term = searchInput.value.trim();
            fetchCategories(term);
        });

        // Pressing Enter triggers search
        searchInput.addEventListener('keyup', function (e) {
            if (e.key === 'Enter') {
                fetchCategories(searchInput.value.trim());
            }
        });

        // Add new category
        addBtn.addEventListener('click', function () {
            const name = searchInput.value.trim();
            if (!name) {
                frappe.msgprint({ title: 'Error', message: 'Category Name is required', indicator: 'red' });
                return;
            }

            frappe.call({
                method: 'frappe.client.insert',
                args: {
                    doc: {
                        doctype: 'Expense Category',
                        category_name: name
                    }
                },
                callback: function (r) {
                    if (r.message) {
                        frappe.msgprint({ title: 'Success', message: `Category "${name}" saved!`, indicator: 'green' });
                        searchInput.value = '';
                        list.innerHTML = '';
                        list.style.display = 'none';
                        addBtn.style.display = 'none';
                    }
                },
                error: function (err) {
                    frappe.msgprint({ title: 'Error', message: 'Failed to save category', indicator: 'red' });
                    console.error(err);
                }
            });
        });

    });
</script>

{% endblock %}